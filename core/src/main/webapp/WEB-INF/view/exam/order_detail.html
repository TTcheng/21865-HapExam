<#include "../include/header.html">
<script src="${base.contextPath}/common/code?orderStatusData=SALE_ORDER_STATUS" type="text/javascript"></script>
<script src="${base.contextPath}/common/profile?submitData=HAP_OM_ORDER_SUBMIT_CTL" type="text/javascript"></script>
<script src="${base.contextPath}/common/profile?approveData=HAP_ OM_ORDER_APPROVE_CTL" type="text/javascript"></script>
<script type="text/javascript">
    var viewModel = Hap.createGridViewModel("#grid");
</script>
<body>
<div id="page-content">
    <!--条件查询-->
    <div class="div" id="query_form" style="margin: 10px">
        <div class="row">
            <div class="col-xs-3">
                <div class="pull-right">
                    <label><@spring.message "omorderheaders.ordernumber"/></label>
                    <input type="text" id="orderNum" placeholder=''
                           data-bind="value:orderNumber,text:orderNumber">
                </div>
            </div>
            <div class="col-xs-3">
                <div class="pull-right">
                    <label><@spring.message "orgcompanys.companyName"/></label>
                    <input type="text" id="companyName" placeholder=''
                           data-bind="value:model.companyId,text:model.companyName">
                </div>
            </div>
            <div class="col-xs-3">
                <div class="pull-right">
                    <label><@spring.message "arcustomers.customername"/></label>
                    <input type="text" id="customerName" placeholder=''
                           data-bind="value:model.customerId,text:model.customerName">
                </div>
            </div>
            <div class="col-xs-3"></div>
        </div>
        <div class="row" style="margin-top: 20px">
            <div class="col-xs-3">
                <div class="pull-right">
                    <label><@spring.message "omorderheaders.orderdate"/></label>
                    <input type="text" id="orderDate" placeholder=''
                           data-bind="value:model.orderDate,text:model.orderDate">
                </div>
            </div>
            <div class="col-xs-3">
                <div class="pull-right">
                    <label for="totalPrice"><@spring.message "omorderheaders.totalprice"/></label>
                    <input id="totalPrice" data-value-primitive="true"
                           data-bind="value: model.totalPrice"/>
                </div>
            </div>
            <div class="col-xs-3">
                <div class="pull-right">
                    <label for="orderStatus"><@spring.message "omorderheaders.orderstatus"/></label>
                    <input id="orderStatus" data-value-primitive="true"
                           data-bind="value: model.data()[0].orderStatus,text:model.data()[0].orderStatus"/>
                </div>
            </div>
            <div class="col-xs-3"></div>
        </div>
    </div>
    <div class="row pull-left" id="query-btns" style="margin-top: 20px;margin-bottom: 20px">
            <span id="btnBack" class="btn btn-default" style="float:right;width:70px;margin-right:5px;"
                  onclick="back2query()" type="button"><@spring.message "hap.back"/>
            </span>
        <span id="btnVoucherPrint" class="btn btn-default" style="float:right;width:80px;margin-right:5px;"
              onclick="" type="button"><@spring.message "orderbtns.voucherprint"/>
            </span>
        <span id="btnDeleteAll" class="btn btn-default" style="float:right;width:80px;margin-right:5px;"
              onclick="" type="button"><@spring.message "orderbtns.deleteall"/>
            </span>
        <span id="btnReject" class="btn btn-default" style="float:right;width:70px;margin-right:5px;"
              onclick="" type="button"><@spring.message "orderbtns.reject"/>
            </span>
        <span id="btnApprove" class="btn btn-default" style="float:right;width:70px;margin-right:5px;"
              data-bind="click:submit" type="button"><@spring.message "orderbtns.approve"/>
            </span>
        <span id="btnSubmit" class="btn btn-default" style="float:right;width:70px;margin-right:5px;"
              data-bind="click:submit" type="submit"><@spring.message "hap.submit"/>
            </span>
        <span id="btnSave" class="btn btn-default" style="float:right;width:70px;margin-right: 5px"
              data-bind="click:save" type="submit"><@spring.message "hap.save"/>
            </span>
        <!--<div class="col-xs-9 offset3"></div>-->
    </div>
    <script>kendo.bind($('#query-btns'),viewModel);</script>
    <div style="clear:both"></div>

    <!--展示表格-->
    <div class="col-sm-12" style="margin-top: 10px;">
        <div id="tabstrip">
            <ul>
                <li id="maintab1">主要</li>
                <li id="othertab">其他</li>
            </ul>
            <div class="tab-pane fade in active" style="margin-top: 10px;" id="main">
                <div style="clear:both">
                    <div id="grid"></div>
                </div>
            </div>
            <div class="tab-pane fade in active" style="margin-top: 10px;" id="other">
                <div style="clear:both">
                    <div id="othergrid"></div>
                </div>
            </div>
        </div>·
    </div>
</div>

<script type="text/javascript">
    Hap.initEnterQuery('#query-form', viewModel.query);
    var BaseUrl = _basePath;
    var headerId = '${RequestParameters.headerId!0}';


    var headerDataSource = new kendo.data.DataSource({
        transport: {
            read: {
                // url: BaseUrl + "/hap/om/order/headers/queryOne",
                url: BaseUrl + "/order/querySummary",
                type: "POST",
                dataType: "json",
                // data:{
                //     headerId:headerId
                // }
            },
            /*update: {
                url: BaseUrl + "/hap/om/order/headers/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/hap/om/order/headers/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hap/om/order/headers/submit",
                type: "POST",
                contentType: "application/json"
            },*/
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type);
                    datas.headerId = headerId;
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    var datas = Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                    datas.headerId = headerId;
                    return datas;
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            total: 'total',
            data: function (response) {
                if (response.total > 0) {
                    return response.rows[0];
                }
                return {};
            },
            model: {
                id: "headerId",
                fields: {
                    headerId: {type: 'long'},
                    companyId: {type: 'long'},
                    customerId: {type: 'long'},
                    orderNumber: {type: 'string'},
                    customerName: {type: 'string'},
                    companyName: {type: 'string'},
                    inventoryItemId: {type: 'long'},
                    totalPrice: {type: 'long'},
                    orderDate: {type: 'date'}
                }
            }
        }
    });

    var headerViewModel = kendo.observable({model:headerDataSource});
    kendo.bind($('#query-form'), headerViewModel);

// headerDataSource.bind("requestEnd", initPage);
    headerDataSource.fetch().then(function () {
        // kendo.bind($('#companyName,#customerName,#itemId,#orderStatus'),headerViewModel);
        // kendo.observable($.extend({model: {}},undefined));
        // kendo.bind($('#orderStatus'),headerViewModel);
        // kendo.bind($('#orderNum'),headerViewModel);
        initPage();
    });
    // headerDataSource.read();
    lineDataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/order/queryDetail",
                type: "POST",
                dataType: "json"
            },
            /*update: {
                url: BaseUrl + "/hap/om/order/headers/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/hap/om/order/headers/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hap/om/order/headers/submit",
                type: "POST",
                contentType: "application/json"
            },*/
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type);
                    datas.headerId = headerId;
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    var parameter = Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                    parameter.headerId = headerId;
                    return parameter
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "lineId",
                fields: {
                    lineId: {type: 'long'},
                    headerId: {type: 'long'},
                    companyId: {type: 'long'},
                    inventoryItemId: {type: 'long'},
                    lineNumber: {type: 'long'},
                    orderQuantity: {type: 'string'},
                    orderQuantityUom: {type: 'string'},
                    description: {type: 'string'},
                    unitSellingPrice: {type: 'long'},
                    orderPrice: {type: 'long'},
                    // orderDate: {type: 'date'},
                    addition1:{type:'string'},
                    addition2:{type:'string'},
                    addition3:{type:'string'},
                    addition4:{type:'string'},
                    addition5:{type:'string'}
                }
            }
        }
    });


    $("#grid").kendoGrid({
        dataSource: lineDataSource,
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable:false,// 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        toolbar: [
            {
                name: "create",
                template: '<span onclick="newLine()" class="btn btn-primary k-grid-add"><@spring.message "hap.new"/></span>'
            },
            {
                template: '<span onclick="editLine()" class="btn btn-success" ><@spring.message "hap.save"/></span>'
            },
            {
                template: '<span  onclick="deleteData()"  class="btn btn-danger"><@spring.message "hap.delete"/></span>'
            }
        ],
        columns: [
            {
                field: "lineNumber",
                title: '<@spring.message "omorderlines.linenumber"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 40
            },
            {
                field: "itemCode",
                title: '<@spring.message "invinventoryitems.itemcode"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },{
                field: "itemDescription",
                title: '<@spring.message "invinventoryitems.itemdescription"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "orderQuantityUom",
                title: '<@spring.message "omorderlines.orderquantityuom"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },{
                field: "orderdQuantity",
                title: '<@spring.message "omorderlines.quantity"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },{
                field: "unitSellingPrice",
                title: '<@spring.message "omorderlines.sellingprice"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },{
                field: "orderPrice",
                title: '<@spring.message "ordertips.orderprice"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            }, {
                field: "description",//备注
                title: '<@spring.message "omorderlines.description"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },
        ],
        editable: true
    });

    $("#othergrid").kendoGrid({
        dataSource: lineDataSource,
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable: 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        toolbar: [
            {
                name: "create",
                template: '<span onclick="newLine()" class="btn btn-primary k-grid-add"><@spring.message "hap.new"/></span>'
            },
            {
                template: '<span onclick="editLine()" class="btn btn-success" ><@spring.message "hap.save"/></span>'
            },
            {
                template: '<span  onclick="deleteData()"  class="btn btn-danger"><@spring.message "hap.delete"/></span>'
            }
        ],
        columns: [
            {
                field: "lineNumber",
                title: '<@spring.message "omorderlines.linenumber"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 40
            },
            {
                field: "addition1",
                title: '<@spring.message "omorderlines.addition1"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "addition2",
                title: '<@spring.message "omorderlines.addition2"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "addition3",
                title: '<@spring.message "omorderlines.addition3"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "addition4",
                title: '<@spring.message "omorderlines.addition4"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },
            {
                field: "addition5",
                title: '<@spring.message "omorderlines.addition5"/>',
                attributes: {style: "text-align:center"},
                headerAttributes: {style: "text-align:center"},
                width: 120
            },
        ],
        editable: true
    });


    //为编号选择文本框添加下拉选项
    $("#orderNum").kendoAutoComplete({
        dataTextField: "orderNumber",
        dataSource: headerDataSource
    });

    $("#totalPrice").kendoAutoComplete({
        dataTextField: "totalPrice",
        dataSource: headerDataSource,
        enable: false,
        template: function (model) {
            var v = model.orderStatus;
            $.each(orderStatusData, function (index, item) {
                if ((item.value || '').toUpperCase() === (v || '').toUpperCase()) {
                    v = item.meaning;
                    return v;
                }
            });
            return v;
        }
    });

    $("#orderStatus").kendoAutoComplete({
        dataTextField: '',
        dataSource: headerDataSource,
        enable: false
    });

    //自动根据当前屏幕大小调整表格
    Hap.autoResizeGrid("#grid");
    //设置订单状态下拉框
    /*$("#orderStatus").kendoComboBox({
        dataTextField: "meaning",
        dataValueField: "value",
        dataSource: orderStatusData
    });*/
    //设置时间选择器
    $("#orderDate").kendoDatePicker({
        animation: {
            close: {},
            open: {}
        },
        format: "{0:yyyy-MM-dd}",
        dataSource: headerDataSource,
        change: function () {
            // 事件
        }
    });
    $("#companyName").kendoLov(${lovProvider.getLov(base.contextPath, base.locale,"LOV_ORG_COMPANY")});
    $("#customerName").kendoLov(${lovProvider.getLov(base.contextPath, base.locale,"LOV_AR_CUSTOMER")});
    $("#itemId").kendoLov(${lovProvider.getLov(base.contextPath, base.locale,"LOV_INV_ITEM")});
    // kendo.bind($('#companyName,#customerName,#itemId,#orderStatus'),headerViewModel);


    function back2query() {
        parent.openTab('ORDER_QUERY','<@spring.message "ordertips.orderquery"/>','exam/order_summary.html');
    }

    function initPage() {
        if (headerId != 0) {
            initUpdate();
        } else {
            initAdd();
        }
    }

    function initAdd() {
        viewModel.model.set("orderDate", new Date());
        viewModel.model.set("orderStatus", "NEW");
        accessControl("NEW");
        viewModel.create();
    }

    function initUpdate() {
        accessControl(headerDataSource.data()[0].orderStatus);
    }

    function accessControl(orderStatus) {
        orderStatus = orderStatus || '';
        var grid = $("#grid").data("kendoGrid");
        if (orderStatus.toUpperCase() === 'NEW' || orderStatus === 'REJECTED') {
            $("#btnDeleteAll,#btnSubmit,#btnSave").attr("disabled", false);
            if (submitData == 'N') {
                $("#submit").attr("disabled", true);
            }
        } else {
            $("#btnDeleteAll,#btnSubmit,#btnSave").attr("disabled", true);
            grid.setOptions({editable:false});
        }
        if (orderStatus.toUpperCase() === 'SUBMITED' && approveData == 'Y') {
            $("#btnApprove,#btnReject").attr("disabled", false);
        } else {
            $("#btnApprove,#btnReject").attr("disabled", true);
        }
    }
    //todo newLine() editLine()

    //tab页切换
    var tabstrip =  $("#tabstrip").kendoTabStrip({
        animation: {
            close: {
                duration: 200,
                effects: "fadeOut"
            },
            open: {
                duration: 200,
                effects: "fadeIn"
            }
        }
    }).data("kendoTabStrip");
    tabstrip.select($("#maintab1"));
</script>
</body>
</html>